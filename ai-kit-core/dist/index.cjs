"use strict";var q=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames;var We=Object.prototype.hasOwnProperty;var k=(e,t)=>()=>(e&&(t=e(e=0)),t);var z=(e,t)=>{for(var r in t)q(e,r,{get:t[r],enumerable:!0})},Ne=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ze(t))!We.call(e,n)&&n!==r&&q(e,n,{get:()=>t[n],enumerable:!(a=Ue(t,n))||a.enumerable});return e};var _e=e=>Ne(q({},"__esModule",{value:!0}),e);function L(){return globalThis.WpSuite?.plugins?.aiKit}async function H(e=8e3){let t=L();if(t?.status!=="available"){if(t?.status==="error")throw new Error("AiKit failed");await new Promise((r,a)=>{let n=()=>o(r),i=()=>o(()=>a(new Error("AiKit failed"))),o=l=>{window.removeEventListener("wpsuite:ai-kit:ready",n),window.removeEventListener("wpsuite:ai-kit:error",i),s&&clearTimeout(s),l()};window.addEventListener("wpsuite:ai-kit:ready",n,{once:!0}),window.addEventListener("wpsuite:ai-kit:error",i,{once:!0});let s=e?window.setTimeout(()=>o(()=>a(new Error("AiKit timeout"))),e):0})}}async function ae(e=1e4){await H(e);let r=L()?.features?.store;if(!r)throw new Error("AiKit store is not available");return r}var j=k(()=>{"use strict"});var oe,A,V,$,G,qe,He,je,Ve,$e,ie,K,se,ue,W=k(()=>{"use strict";oe=require("@smart-cloud/wpsuite-core"),A=require("@wordpress/data"),V=require("aws-amplify/utils");j();typeof WpSuite<"u"?$=WpSuite.siteSettings:$={};G=e=>{let t=e&&typeof e=="object"?e:{},r={};return typeof t.mode=="string"&&(r.mode=t.mode),typeof t.backendTransport=="string"&&(r.backendTransport=t.backendTransport),typeof t.backendApiName=="string"&&(r.backendApiName=t.backendApiName),typeof t.backendBaseUrl=="string"&&(r.backendBaseUrl=t.backendBaseUrl),typeof t.subscriptionType=="string"&&(r.subscriptionType=t.subscriptionType),typeof t.enableChatbot=="boolean"&&(r.enableChatbot=t.enableChatbot),typeof t.chatbot=="object"&&t.chatbot!==null&&(r.chatbot=t.chatbot),r},qe=async()=>{let e=L();if(!e)throw new Error("AI-Kit plugin is not available");let t=null;return e.settings.customTranslationsUrl&&(t=await fetch(e.settings.customTranslationsUrl+(e.settings.customTranslationsUrl.includes("?")?"&":"?")+"t="+$.lastUpdate).then(r=>r.ok?r.text():null).then(r=>r?JSON.parse(r):null).catch(()=>null)),t??null},He=async()=>{let e=G(await(0,oe.getConfig)("aiKit")),t=await qe();return{config:e,showChatbotPreview:!1,language:void 0,direction:void 0,customTranslations:t}},je={setShowChatbotPreview(e){return{type:"SET_SHOW_CHATBOT_PREVIEW",showChatbotPreview:e}},setLanguage(e){return!e||e==="system"?V.I18n.setLanguage(""):V.I18n.setLanguage(e),{type:"SET_LANGUAGE",language:e}},setDirection(e){return{type:"SET_DIRECTION",direction:e}}},Ve={getConfig(e){return e.config},isShowChatbotPreview(e){return e.showChatbotPreview},getCustomTranslations(e){return e.customTranslations},getLanguage(e){return e.language},getDirection(e){return e.direction},getState(e){return e}},$e={},ie=e=>(0,A.dispatch)(e),K=e=>(0,A.select)(e),se=async()=>{let e=await He(),t=(0,A.createReduxStore)("wpsuite/ai-kit",{reducer(r=e,a){switch(a.type){case"SET_LANGUAGE":return{...r,language:a.language};case"SET_DIRECTION":return{...r,direction:a.direction};case"SET_SHOW_CHATBOT_PREVIEW":return{...r,showChatbotPreview:a.showChatbotPreview}}return r},actions:je,selectors:Ve,resolvers:$e});return(0,A.register)(t),t},ue=(e,t,r)=>{let a;function n(){let o=K(e).getState(),s=t(o);if(s!==a){let l=a;a=s,r(a,l)}}let i=(0,A.subscribe)(n,e);return n(),i}});var y,le=k(()=>{"use strict";y="smartcloud-ai-kit"});var C,Ge,Xe,ce=k(()=>{"use strict";C=require("react/jsx-runtime"),Ge=e=>(0,C.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",width:"48",height:"48",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...e,children:[(0,C.jsx)("path",{d:"M19 27H33"}),(0,C.jsx)("path",{d:"M19 33H33"}),(0,C.jsx)("path",{d:"M8 21L9.5 24L12.5 25.5L9.5 27L8 30L6.5 27L3.5 25.5L6.5 24Z"}),(0,C.jsx)("path",{d:"M36 4L38 8L42 10L38 12L36 16L34 12L30 10L34 8Z"}),(0,C.jsx)("path",{d:"M16 10V40H36V22"}),(0,C.jsx)("path",{d:"M16 10H22"}),(0,C.jsx)("path",{d:"M22 10V23H36"}),(0,C.jsx)("path",{d:"M22 10L36 22"})]}),Xe=e=>(0,C.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",width:"48",height:"48",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...e,children:[(0,C.jsx)("path",{d:"M42 38L34 30H10C7.79086 30 6 28.2091 6 26V8C6 5.79086 7.79086 4 10 4H38C40.2091 4 42 5.79086 42 8V38Z"}),(0,C.jsx)("rect",{x:"14",y:"13",width:"6",height:"6",rx:"1"}),(0,C.jsx)("rect",{x:"28",y:"13",width:"6",height:"6",rx:"1"}),(0,C.jsx)("path",{d:"M16 24H32"})]})});var P,X=k(()=>{"use strict";P=class extends Error{constructor(r,a,n){super(r);this.decision=a;this.status=n;this.name="AiBackendError"}}});var ye={};z(ye,{MIN_CHROME_VERSION:()=>me,checkOnDeviceAvailability:()=>be,decideCapability:()=>_,resolveBackend:()=>E});async function ge(){let t=await Je?.plugins?.aiKit?.features.store;return K(t).getConfig()??{}}function pe(e){let t=e.backendApiName?.trim()||void 0,r=e.backendBaseUrl?.trim()||void 0;return{transport:e.backendTransport??(r?"fetch":t?"gatey":void 0),backendApiName:t,backendBaseUrl:r}}function Qe(e){if(e.mode)return e.mode;let{transport:t}=pe(e);return t?"backend-fallback":"local-only"}async function E(){let e=await ge(),{transport:t,backendApiName:r,backendBaseUrl:a}=pe(e);if(!t)return{available:!1,reason:"No backend configured"};if(t==="fetch")return a?{available:!0,transport:t,baseUrl:a,reason:"Custom fetch backend"}:{available:!1,reason:"backendBaseUrl is missing"};if(!r)return{available:!1,reason:"backendApiName is missing"};let n=globalThis.WpSuite?.plugins?.gatey;return!n?.availability||await n.availability()!=="available"?{available:!1,reason:"Gatey is not available"}:{available:!0,transport:t,apiName:r,reason:"Gatey backend"}}function S(e){return typeof globalThis[e]<"u"}function fe(e){if(!e)return;let t=Number.parseInt(String(e).split(".")[0]??"",10);return Number.isFinite(t)?t:void 0}function N(e,t){return e?.find(r=>r.brand===t)?.version}async function Ze(){let e=navigator?.userAgentData;if(e){try{let r=(await e.getHighEntropyValues?.(["fullVersionList"]))?.fullVersionList;if(Array.isArray(r)&&r.length>0)return r}catch{}if(Array.isArray(e.brands)&&e.brands.length>0)return e.brands}}function Ye(e){let t=e.match(/\b(?:Chrome|Chromium)\/(\d{2,3})\b/i);return t?.[1]?fe(t[1]):void 0}function et(){return!!navigator?.brave}async function tt(e){if(typeof navigator>"u")return{allowed:!1,reason:"no-navigator"};if(typeof globalThis.isSecureContext=="boolean"&&!globalThis.isSecureContext)return{allowed:!1,reason:"not-secure-context"};let t=navigator.userAgent??"",r=await Ze(),a=N(r,"Microsoft Edge")??N(r,"Microsoft Edge WebView2"),n=N(r,"Google Chrome")??N(r,"Chromium"),i=!!a||/\bEdg\//i.test(t)||/\bEdgiOS\//i.test(t),o=/\bOPR\//i.test(t),s=/\bVivaldi\//i.test(t),l=/\bSamsungBrowser\//i.test(t),u=/\bFirefox\//i.test(t),c=!/\bChrome\//i.test(t)&&/\bSafari\//i.test(t)&&!/\bChromium\//i.test(t),m=et()||/\bBrave\//i.test(t);if(i||o||s||l||u||c||m)return{allowed:!1,reason:i?"edge":m?"brave":u?"firefox":c?"safari":o?"opera":s?"vivaldi":l?"samsung":"unsupported-browser"};let g=fe(n)??Ye(t),f=me[e];return f?g?g<f?{allowed:!1,reason:`chrome-too-old-${g}-lt-${f}`,chromeMajor:g}:{allowed:!0,reason:"ok",chromeMajor:g}:{allowed:!1,reason:"unknown-chrome-version"}:{allowed:!1,reason:"no-min-version",chromeMajor:g}}async function be(e,t){try{let r=await tt(e),a=`browser-gate:${r.reason}${r.chromeMajor?` (chrome ${r.chromeMajor})`:""}`;if(!r.allowed)return{available:!1,status:"unavailable",reason:a};switch(e){case"writer":{if(!S("Writer")||!Writer?.availability)return{available:!1,status:"api-not-present",reason:a};let n=await Writer.availability(t);return{available:n!=="unavailable",status:n,reason:a}}case"rewriter":{if(!S("Rewriter")||!Rewriter?.availability)return{available:!1,status:"api-not-present",reason:a};let n=await Rewriter.availability(t);return{available:n!=="unavailable",status:n,reason:a}}case"summarizer":{if(!S("Summarizer")||!Summarizer?.availability)return{available:!1,status:"api-not-present",reason:a};let n=await Summarizer.availability(t);return{available:n!=="unavailable",status:n,reason:a}}case"proofreader":{if(!S("Proofreader")||!Proofreader?.availability)return{available:!1,status:"api-not-present",reason:a};let n=await Proofreader.availability(t);return{available:n!=="unavailable",status:n,reason:a}}case"language-detector":{if(!S("LanguageDetector")||!LanguageDetector?.availability)return{available:!1,status:"api-not-present",reason:a};let n=await LanguageDetector.availability(t);return{available:n!=="unavailable",status:n,reason:a}}case"translator":{if(!S("Translator")||!Translator?.availability)return{available:!1,status:"api-not-present",reason:a};let n=t;if(!n?.sourceLanguage||!n?.targetLanguage)return{available:!1,status:"error",reason:a,error:new Error("Translator.availability requires sourceLanguage/targetLanguage")};let i=await Translator.availability({...n,sourceLanguage:n.sourceLanguage==="auto"?"en":n.sourceLanguage,targetLanguage:n.sourceLanguage==="auto"||n.sourceLanguage===n.targetLanguage?"hu":n.targetLanguage});return{available:i!=="unavailable",status:i,reason:a}}case"prompt":{if(!S("LanguageModel")||!LanguageModel?.availability)return{available:!1,status:"api-not-present",reason:a};let n=await LanguageModel.availability(t);return{available:n!=="unavailable",status:n,reason:a}}default:return{available:!1,status:"unknown-feature",reason:a}}}catch(r){return{available:!1,status:"error",reason:"exception in availability()",error:r}}}async function _(e,t,r){let a=await ge(),n=r||Qe(a),i=await E(),o=await be(e,t),s=o.available,l=i.available,u={feature:e,mode:n,onDeviceAvailable:s,onDeviceStatus:o.status,onDeviceReason:o.reason,backendAvailable:l,backendTransport:i.transport,backendApiName:i.apiName,backendBaseUrl:i.baseUrl,backendReason:i.reason};return n==="local-only"?s?{...u,source:"on-device",reason:`local-only: on-device available (${o.reason??o.status})`}:{...u,source:"none",reason:`local-only: on-device unavailable (${o.reason??o.status})`}:n==="backend-only"?l?{...u,source:"backend",reason:`backend-only: backend available (${i.reason??"n/a"})`}:{...u,source:"none",reason:`backend-only: backend unavailable (${i.reason??"n/a"})`}:s?{...u,source:"on-device",reason:`backend-fallback: using on-device (${o.reason??o.status})`}:l?{...u,source:"backend",reason:`backend-fallback: using backend (${i.reason??"n/a"}; on-device: ${o.reason??o.status})`}:{...u,source:"none",reason:`No on-device AI or backend available (on-device: ${o.reason??o.status}; backend: ${i.reason??"n/a"})`}}var de,Je,me,J=k(()=>{"use strict";de=require("@smart-cloud/wpsuite-core");W();Je=(0,de.getWpSuite)();me={summarizer:138,translator:138,"language-detector":138,writer:137,rewriter:137,proofreader:141,prompt:138}});var ke={};z(ke,{dispatchBackend:()=>I,withRecaptchaHeaders:()=>F});function rt(){return globalThis.WpSuite?.plugins?.aiKit?.settings??{}}function nt(e){if(!e)return;let t=Date.parse(e);return Number.isFinite(t)?t:void 0}function at(e){let t=e?.reCaptchaChatTtlSeconds,r=typeof t=="number"&&Number.isFinite(t)?Math.max(0,t):120;return Math.min(3600,r)*1e3}function ot(e,t){let r=at(t);if(r<=0)return!1;let a=ve.get(e);return a?Date.now()-a<r:!1}function Q(e,t){let r=nt(t);r&&ve.set(e,r)}function he(e,t,r){if(e!=="frontend"||t!=="prompt"||!Ae(r)||r.saveChatSession!==!0)return;let a=r.sessionId;return typeof a=="string"&&a.trim()?a.trim():void 0}function Ce(e,t){if(!e)return;try{if(typeof e.get=="function")return e.get(t)??void 0}catch{}let r=Object.keys(e).find(n=>n.toLowerCase()===t.toLowerCase());if(!r)return;let a=e[r];return typeof a=="string"&&a?a:void 0}async function it(e,t){if(e!=="frontend")return;let r=rt();if(!r?.reCaptchaSiteKey||t?.cacheKey&&ot(t.cacheKey,r))return;let{execute:a}=await(0,we.getRecaptcha)(r?.useRecaptchaEnterprise||!1);if(typeof a=="function")try{let i=await a(r.reCaptchaSiteKey,{action:"generate"});return typeof i=="string"&&i?i:void 0}catch{return}}async function F(e,t,r){if(e!=="frontend"||t["X-Recaptcha-Token"]||t["x-recaptcha-token"])return t;let a=await it(e,r);return a?{...t,"X-Recaptcha-Token":a}:t}function B(e,t){try{e?.onStatus?.(t)}catch{}}function Ae(e){return typeof e=="object"&&e!==null&&(Object.getPrototypeOf(e)===Object.prototype||Object.getPrototypeOf(e)===null)}function ut(e,t){if(!Ae(t))return t;let r=st[e];if(!r)return t;let a={};for(let n of r)n in t&&(a[n]=t[n]);return a}function dt(e,t){return(e==="admin"?lt:ct)[t]}async function I(e,t,r,a,n={}){let i=dt(t,r),o=ut(r,a);if(!i)throw new P(`No backend path configured for "${r}" (${t}).`,e);if(e.backendTransport==="fetch"){if(!e.backendBaseUrl)throw new P("backendTransport=fetch but backendBaseUrl is missing.",e);return gt(e.backendBaseUrl,i,o,n,e,r,t)}if(!e.backendApiName)throw new P("backendTransport=gatey but backendApiName is missing.",e);return pt(e.backendApiName,i,o,n,e,r,t)}async function gt(e,t,r,a,n,i,o){let s=`${e.replace(/\/+$/,"")}${t}`,l={"content-type":"application/json",...a.headers??{}},u=he(o,i,r),c=await F(o,l,{cacheKey:u}),m=a.query&&Object.keys(a.query).length>0?"?"+new URLSearchParams(Object.entries(a.query).map(([p,h])=>[p,String(h)])).toString():"";B(a,{feature:i,context:o,step:"backend:request",source:"backend"}),B(a,{feature:i,context:o,step:"backend:waiting",source:"backend"});let g=await fetch(s+m,{method:"POST",headers:c,body:JSON.stringify(r??{}),signal:a.signal,credentials:"omit"});if(B(a,{feature:i,context:o,step:"backend:response",source:"backend"}),!g.ok){let p=`HTTP ${g.status}`;try{let h=await g.text();h&&(p=`${p}: ${h.substring(0,400)}`)}catch{}throw new P(`Fetch backend call failed: ${p}`,n,g.status)}let f=g.headers.get("content-type")||"",b=Ce(g.headers,"x-recaptcha-verified-at");if(f.includes("application/json")){let p=await g.json(),h=(p&&typeof p.sessionId=="string"&&p.sessionId.trim()?p.sessionId.trim():void 0)??u;return b&&h&&Q(h,b),p}return b&&u&&Q(u,b),await g.text()}async function pt(e,t,r,a,n,i,o){let l=globalThis.WpSuite?.plugins?.gatey;if(!l?.cognito?.post)throw new P("Gatey backend selected, but Gatey.cognito.post is not available.",n);let u=he(o,i,r),c=await F(o,{...a.headers??{}},{cacheKey:u});B(a,{feature:i,context:o,step:"backend:request",source:"backend"}),B(a,{feature:i,context:o,step:"backend:waiting",source:"backend"});let m=l.cognito.post({apiName:e,path:t,options:{body:r,headers:c,retryStrategy:{strategy:"no-retry"}}});a?.signal?.addEventListener?.("abort",()=>{m.cancel()});let g=await m.response,f=Ce(g.headers,"x-recaptcha-verified-at"),b=await g.body.json(),p=b?.sessionId??u;return f&&typeof p=="string"&&p.trim()&&Q(p.trim(),f),B(a,{feature:i,context:o,step:"backend:response",source:"backend"}),b}var we,ve,st,lt,ct,Z=k(()=>{"use strict";we=require("@smart-cloud/wpsuite-core");X();ve=new Map;st={prompt:["text","systemPrompt","context","responseConstraint","saveChatSession","sessionId","images","imageUrls","feedbackMessageId","feedbackType","knowledgeBaseId","disableKB","enableRerank","kb_filters"],writer:["text","outputLanguage","instruction","context","tone","format","length","knowledgeBaseId","disableKB"],rewriter:["text","outputLanguage","instruction","context","tone","format","length"],summarizer:["text","outputLanguage","instruction","context","type","format","length"],translator:["text","sourceLanguage","targetLanguage"],"language-detector":["text","maxCandidates"],proofreader:["text","expectedInputLanguages"]};lt={prompt:"/admin/prompt",writer:"/admin/write",rewriter:"/admin/rewrite",summarizer:"/admin/summarize",translator:"/admin/translate","language-detector":"/admin/detect-language",proofreader:"/admin/proofread"},ct={prompt:"/frontend/prompt",writer:"/frontend/write",rewriter:"/frontend/rewrite",summarizer:"/frontend/summarize",translator:"/frontend/translate","language-detector":"/frontend/detect-language",proofreader:"/frontend/proofread"}});var Fe={};z(Fe,{detectLanguage:()=>Tt,getPromptOptions:()=>Ee,getProofreadOptions:()=>Oe,getRewriteOptions:()=>Te,getSummarizeOptions:()=>Re,getTranslateOptions:()=>Be,getWriteOptions:()=>Se,prompt:()=>Ut,proofread:()=>Lt,rewrite:()=>xt,sendChatMessage:()=>zt,sendFeedbackMessage:()=>Wt,summarize:()=>St,translate:()=>U,write:()=>Pt});function x(){return(xe?.plugins?.aiKit?.settings??{}).defaultOutputLanguage??"en"}function M(e){let t=["en","ja","es"],r=e.toLowerCase();return t.some(a=>r===a.toLowerCase())}function d(e,t,r,a){try{r?.onStatus?.({feature:e,context:t,...a})}catch{}}function D(){return xe?.plugins?.aiKit?.settings?.sharedContext??void 0}function T(e){return e?.context??"admin"}function O(e,t=mt){let r=new AbortController,a=e?.signal,n=typeof e?.onDeviceTimeoutOverride=="number"?e.onDeviceTimeoutOverride:void 0,i=typeof n=="number"?n:t,o,s=!1,l=()=>{if(r.signal.aborted)return;let u=typeof a?.reason<"u"?a?.reason:void 0;r.abort(u??new DOMException("Aborted","AbortError"))};return a&&(a.aborted?l():a.addEventListener("abort",l)),i&&i>0&&(o=setTimeout(()=>{r.signal.aborted||(s=!0,r.abort(new Y(i)))},i)),{signal:r.signal,timedOut:()=>s,dispose:()=>{o&&(clearTimeout(o),o=void 0),a&&a.removeEventListener("abort",l)}}}function ee(e){let t=e;return{knowledgeBaseId:typeof t.knowledgeBaseId=="string"?t.knowledgeBaseId:void 0,disableKB:typeof t.disableKB=="boolean"?t.disableKB:void 0}}async function ft(e,t,r,a){let n=ee(e),i=await Ke(e.images,r,t,a);return{text:e.messages.filter(o=>o.role==="user").map(o=>o.content).join(`
`),systemPrompt:e.messages.filter(o=>o.role==="system").map(o=>o.content).join(`
`),images:i?.images,imageUrls:i?.imageUrls,context:e.sharedContext,saveChatSession:!1,responseConstraint:e.responseConstraint,...n}}async function bt(e,t,r){let a=ee(e),n=await Ke(e.images,t,"frontend",r);return{sessionId:e.sessionId,text:e.message,images:n?.images,imageUrls:n?.imageUrls,context:e.sessionId?void 0:e.sharedContext,saveChatSession:!0,...a}}async function yt(e){return{sessionId:e.sessionId,feedbackMessageId:e.feedbackMessageId,feedbackType:e.feedbackType,saveChatSession:!0}}function wt(e){let t=ee(e);return{text:e.prompt,outputLanguage:e.outputLanguage,instruction:e.context?.trim()?e.context.trim():void 0,context:e.sharedContext,tone:e.tone,format:e.format,length:e.length,...t}}function vt(e){return{text:e.text,outputLanguage:e.outputLanguage,instruction:e.context?.trim()?e.context.trim():void 0,context:e.sharedContext,tone:e.tone,format:e.format,length:e.length}}function ht(e){return{text:e.text,outputLanguage:e.outputLanguage,instruction:e.context?.trim()?e.context.trim():void 0,context:e.sharedContext,type:e.type,format:e.format,length:e.length}}function Ct(e,t,r){return{text:e,sourceLanguage:t,targetLanguage:r}}function At(e,t){let r=t;return{text:e,maxCandidates:typeof r?.maxCandidates=="number"?r.maxCandidates:void 0}}function kt(e){return{text:e.text,expectedInputLanguages:e.expectedInputLanguages}}async function R(e,t,r,a,n,i,o,s){d(a,e,s,{step:"decide",message:"Deciding capability",silent:r});let l=await _(a,n,t);if(d(a,e,s,{step:"decide",source:l.source,message:`Using ${l.source}`,silent:r}),l.source==="on-device")try{let u=await i();return d(a,e,s,{step:"done",source:"on-device",silent:r}),u}catch(u){console.error(`Error in on-device ${a}:`,u),d(a,e,s,{step:"error",source:"on-device",message:u.message,silent:r}),s?.signal?.throwIfAborted()}if(l.mode!=="local-only"&&l.backendAvailable){d(a,e,s,{step:"backend:request",source:"backend",silent:r});let u=typeof o=="function"?await o(l):o,c=await I(l,e,a,u,s);return d(a,e,s,{step:"done",source:"backend",silent:r}),c}throw new Error(`No capability for "${a}" (${e}). Reason: ${l.reason}`)}function Ot(e){let t=Array.isArray(e.images)&&e.images.length>0,r=e.images??[],a=t?r.map(i=>({type:"image",value:i})):[],n;if(typeof e.messages=="string")n=t?[{role:"user",content:[{type:"text",value:e.messages},...a]}]:e.messages;else{let i=e.messages.filter(o=>o.role!=="system").map(o=>({role:o.role==="assistant"?"assistant":"user",content:o.content}));if(t){let o=-1;for(let s=i.length-1;s>=0;s--)if(i[s].role==="user"){o=s;break}if(o===-1)i.push({role:"user",content:[{type:"text",value:""},...a]});else{let s=String(i[o].content??"");i[o]={...i[o],content:[{type:"text",value:s},...a]}}}n=i}return n}function Bt(e){return typeof Blob<"u"&&e instanceof Blob}function Kt(e){let t=(e??"").toLowerCase();return t.includes("png")?"png":t.includes("webp")?"webp":t.includes("gif")?"gif":t.includes("bmp")?"bmp":"jpg"}function Et(e){let t=(e??"").toLowerCase();return t.includes("png")?"png":t.includes("webp")?"webp":t.includes("gif")?"gif":"jpeg"}async function Ft(e){return new Promise((t,r)=>{let a=new FileReader;a.onerror=()=>r(a.error??new Error("FileReader error")),a.onload=()=>t(String(a.result??"")),a.readAsDataURL(e)})}async function It(e){let t=await Ft(e),r=t.indexOf(",");return r>=0?t.substring(r+1):t}async function Mt(e,t,r,a,n,i){let o=t==="admin"?"/admin/generate-upload-url":"/frontend/generate-upload-url",s={...i?.headers??{}},l=await F(t,s);if(e.backendTransport==="fetch"){if(!e.backendBaseUrl)throw new Error("backendBaseUrl missing for fetch transport");let f=new URLSearchParams({fileName:r,contentType:a,contentLength:String(n)}).toString(),b=`${e.backendBaseUrl.replace(/\/+$/,"")}${o}?${f}`,p=await fetch(b,{method:"GET",headers:l,signal:i?.signal,credentials:"omit"});if(!p.ok){let ne=await p.text().catch(()=>"");throw new Error(`generate-upload-url failed (fetch): HTTP ${p.status}${ne?": "+ne.substring(0,200):""}`)}let h=await p.json();if(!h?.uploadUrl||!h?.imageKey)throw new Error("generate-upload-url response missing uploadUrl/imageKey");return{uploadUrl:h.uploadUrl,imageKey:h.imageKey}}if(!e.backendApiName)throw new Error("backendApiName missing for gatey transport");let u=globalThis.WpSuite?.plugins?.gatey,c={fileName:r,contentType:a,contentLength:n};if(u?.cognito?.get){let f=u.cognito.get({apiName:e.backendApiName,path:o,options:{queryParams:Object.keys(c).reduce((p,h)=>(p[h]=String(c[h]),p),{}),headers:l,retryStrategy:{strategy:"no-retry"}}});i?.signal?.addEventListener?.("abort",()=>{f.cancel()});let b=await f.response.then(p=>p.body.json());if(!b?.uploadUrl||!b?.imageKey)throw new Error("generate-upload-url (gatey get) response missing uploadUrl/imageKey");return{uploadUrl:b.uploadUrl,imageKey:b.imageKey}}if(!u?.cognito?.post)throw new Error("Gatey.cognito.post is not available");let m=u.cognito.post({apiName:e.backendApiName,path:o,options:{body:c,headers:l,retryStrategy:{strategy:"no-retry"}}});i?.signal?.addEventListener?.("abort",()=>{m.cancel()});let g=await m.response.then(f=>f.body.json());if(!g?.uploadUrl||!g?.imageKey)throw new Error("generate-upload-url (gatey post) response missing uploadUrl/imageKey");return{uploadUrl:g.uploadUrl,imageKey:g.imageKey}}async function Dt(e,t,r,a){let n=await fetch(e,{method:"PUT",headers:{"Content-Type":r||"application/octet-stream"},body:t,signal:a?.signal});if(!n.ok){let i=await n.text().catch(()=>"");throw new Error(`S3 upload failed: HTTP ${n.status}${i?": "+i.substring(0,200):""}`)}}async function Ke(e,t,r,a){if(!e||e.length===0)return;let n=[];for(let u of e){if(!Bt(u))throw new Error("Backend multimodal prompting currently supports only Blob/File inputs for images.");n.push(u)}let i=n.reduce((u,c)=>u+(c.size||0),0);if(Math.ceil(i*1.37+2048*n.length)<=Rt){d("prompt",r,a,{step:"backend:request",source:"backend",message:"Inlining images as base64"});let u=[];for(let c of n)u.push({format:Et(c.type),data:await It(c)});return{images:u}}d("prompt",r,a,{step:"backend:request",source:"backend",message:"Uploading images via signed URL"});let l=[];for(let u=0;u<n.length;u++){let c=n[u],m=c.type||"application/octet-stream",g=c.name||`image_${u}.${Kt(m)}`;d("prompt",r,a,{step:"backend:request",source:"backend",message:"Requesting signed URL"});let{uploadUrl:f,imageKey:b}=await Mt(t,r,g,m,c.size||0,a);d("prompt",r,a,{step:"backend:waiting",source:"backend",message:"Uploading"}),await Dt(f,c,m,a),l.push(b)}return{imageUrls:l}}var Pe,xe,mt,Le,Y,Se,Pt,Te,xt,Oe,Lt,Re,St,Tt,Be,U,Rt,Ee,Ut,zt,Wt,Ie=k(()=>{"use strict";Pe=require("@smart-cloud/wpsuite-core");Z();J();Me();xe=(0,Pe.getWpSuite)();mt=45e3,Le=5e3,Y=class extends Error{timeoutMs;constructor(t){super(`On-device execution exceeded ${t}ms`),this.name="OnDeviceTimeoutError",this.timeoutMs=t}};Se=e=>{let t=e.outputLanguage?e.outputLanguage:x(),r={tone:e.tone,format:e.format,length:e.length,outputLanguage:t};return Promise.resolve(r)},Pt=async(e,t)=>{let r=T(t),a=e.sharedContext??D(),n=e.outputLanguage?e.outputLanguage:x(),i=n,o=!1;M(n)||(o=!0,n="en");let s=Se({...e,outputLanguage:n});return R(r,t?.modeOverride,!1,"writer",s,async()=>{if(typeof Writer>"u")throw new Error("Writer API not available in this browser.");d("writer",r,t,{step:"on-device:init",source:"on-device",message:"Creating Writer session"});let l=O(t);try{let u=await Writer.create({...s,sharedContext:a,monitor(c){c.addEventListener("downloadprogress",m=>{let g=m.loaded;d("writer",r,t,{step:"on-device:download",source:"on-device",progress:g,loaded:g})})}});d("writer",r,t,{step:"on-device:ready",source:"on-device"});try{d("writer",r,t,{step:"on-device:run",source:"on-device",message:"Generating text"});let c=await u.write(e.prompt,{context:e.context,signal:l.signal});return o?{result:(await U({text:c,sourceLanguage:n,targetLanguage:i},{context:r,signal:l.signal})).result}:{result:c}}finally{try{u.destroy()}catch(c){console.error("Error destroying writer:",c)}}}finally{l.dispose()}},wt({...e,sharedContext:a,outputLanguage:i}),t)},Te=e=>{let t=e.outputLanguage?e.outputLanguage:x(),r={tone:e.tone,format:e.format,length:e.length,outputLanguage:t};return Promise.resolve(r)},xt=async(e,t)=>{let r=T(t),a=e.sharedContext??D(),n=e.outputLanguage?e.outputLanguage:x(),i=n,o=!1;M(n)||(o=!0,n="en");let s=Te({...e,outputLanguage:n});return R(r,t?.modeOverride,!1,"rewriter",s,async()=>{if(typeof Rewriter>"u")throw new Error("Rewriter API not available in this browser.");d("rewriter",r,t,{step:"on-device:init",source:"on-device",message:"Creating Rewriter session"});let l=O(t);try{let u=await Rewriter.create({...s,sharedContext:a,monitor(c){c.addEventListener("downloadprogress",m=>{let g=m.loaded;d("rewriter",r,t,{step:"on-device:download",source:"on-device",progress:g,loaded:g})})}});d("rewriter",r,t,{step:"on-device:ready",source:"on-device"});try{d("rewriter",r,t,{step:"on-device:run",source:"on-device",message:"Rewriting text"});let c=await u.rewrite(e.text,{context:e.context,signal:l.signal});return o?{result:(await U({text:c,sourceLanguage:n,targetLanguage:i},{context:r,signal:l.signal})).result}:{result:c}}finally{try{u.destroy()}catch(c){console.error("Error destroying rewriter:",c)}}}finally{l.dispose()}},vt({...e,sharedContext:a,outputLanguage:i}),t)},Oe=()=>Promise.resolve({includeCorrectionTypes:!0,includeCorrectionExplanations:!0}),Lt=async(e,t)=>{let r=T(t),a=await Oe();return R(r,t?.modeOverride,!1,"proofreader",a,async()=>{if(typeof Proofreader>"u")throw new Error("Proofreader API not available in this browser.");d("proofreader",r,t,{step:"on-device:init",source:"on-device",message:"Creating Proofreader session"});let n=O(t);try{let i=await Proofreader.create({...a,monitor(o){o.addEventListener("downloadprogress",s=>{let l=s.loaded;d("proofreader",r,t,{step:"on-device:download",source:"on-device",progress:l,loaded:l})})}});d("proofreader",r,t,{step:"on-device:ready",source:"on-device"});try{return d("proofreader",r,t,{step:"on-device:run",source:"on-device",message:"Proofreading"}),{result:await i.proofread(e.text,{signal:n.signal})}}finally{try{i.destroy()}catch(o){console.error("Error destroying proofreader:",o)}}}finally{n.dispose()}},kt(e),t)},Re=e=>{let t=e.outputLanguage?e.outputLanguage:x(),r={type:e.type,format:e.format,length:e.length,outputLanguage:t};return Promise.resolve(r)},St=async(e,t)=>{let r=T(t),a=e.sharedContext??D(),n=e.outputLanguage?e.outputLanguage:x(),i=n,o=!1;M(n)||(o=!0,n="en");let s=await Re({...e,outputLanguage:n});return R(r,t?.modeOverride,!1,"summarizer",s,async()=>{if(typeof Summarizer>"u")throw new Error("Summarizer API not available in this browser.");d("summarizer",r,t,{step:"on-device:init",source:"on-device",message:"Creating Summarizer session"});let l=O(t);try{let u=await Summarizer.create({...s,sharedContext:a,monitor(c){c.addEventListener("downloadprogress",m=>{let g=m.loaded;d("summarizer",r,t,{step:"on-device:download",source:"on-device",progress:g,loaded:g})})}});d("summarizer",r,t,{step:"on-device:ready",source:"on-device"});try{d("summarizer",r,t,{step:"on-device:run",source:"on-device",message:"Summarizing"});let c=await u.summarize(e.text,{context:e.context,signal:l.signal});return o?{result:(await U({text:c,sourceLanguage:n,targetLanguage:i},{context:r,signal:l.signal})).result}:{result:c}}finally{try{u.destroy()}catch(c){console.error("Error destroying summarizer:",c)}}}finally{l.dispose()}},ht({...e,sharedContext:a,outputLanguage:i}),t)},Tt=async(e,t)=>{let r=T(t);return R(r,t?.modeOverride,t?.silent,"language-detector",void 0,async()=>{if(typeof LanguageDetector>"u")throw new Error("LanguageDetector API not available in this browser.");d("language-detector",r,t,{step:"on-device:init",source:"on-device",message:"Creating LanguageDetector session",silent:t?.silent});let a=O(t,Le);try{let n=await LanguageDetector.create({monitor(i){i.addEventListener("downloadprogress",o=>{let s=o.loaded;d("language-detector",r,t,{step:"on-device:download",source:"on-device",progress:s,loaded:s,silent:t?.silent})})}});d("language-detector",r,t,{step:"on-device:ready",source:"on-device",silent:t?.silent});try{return d("language-detector",r,t,{step:"on-device:run",source:"on-device",message:"Detecting language",silent:t?.silent}),{result:{candidates:(await n.detect(e.text,{signal:a.signal})).filter(o=>te.find(s=>s.value===o.detectedLanguage))}}}finally{try{n.destroy()}catch(i){console.error("Error destroying language detector:",i)}}}finally{a.dispose()}},At(e.text,t),t)},Be=e=>{let t={sourceLanguage:e.sourceLanguage??"auto",targetLanguage:e.targetLanguage??x()??"en"};return Promise.resolve(t)},U=async(e,t)=>{let r=T(t),a=await Be({...e});return R(r,t?.modeOverride,t?.silent,"translator",a,async()=>{if(typeof Translator>"u")throw new Error("Translator API not available in this browser.");d("translator",r,t,{step:"on-device:init",source:"on-device",message:"Creating Translator session",silent:t?.silent});let n=O(t,Le);try{let i=await Translator.create({...a,monitor(o){o.addEventListener("downloadprogress",s=>{let l=s.loaded;d("translator",r,t,{step:"on-device:download",source:"on-device",progress:l,loaded:l,silent:t?.silent})})}});d("translator",r,t,{step:"on-device:ready",source:"on-device",silent:t?.silent});try{d("translator",r,t,{step:"on-device:run",source:"on-device",message:"Translating",silent:t?.silent});let o=[],s=()=>{if(typeof n.signal.throwIfAborted=="function")n.signal.throwIfAborted();else if(n.signal.aborted)throw n.signal.reason??new DOMException("Aborted","AbortError")};for(let u of e.text.split(`
`))s(),o.push(i.translate(u.trim()));return{result:(await Promise.all(o)).join(`
`)}}finally{try{i.destroy()}catch(o){console.error("Error destroying translator:",o)}}}finally{n.dispose()}},Ct(e.text,e.sourceLanguage,e.targetLanguage),t)};Rt=4*1024*1024;Ee=async e=>{let t=e.outputLanguage?e.outputLanguage:x();return M(t)||(t="en"),{topK:e.topK,temperature:e.temperature,expectedInputs:[{type:"text"},{type:"image"}],expectedOutputs:[{type:"text",languages:[t]}]}},Ut=async(e,t)=>{let r=T(t),a=e.sharedContext??D(),n=e.outputLanguage?e.outputLanguage:x(),i=n,o=!1;M(n)||(o=!0,n="en");let s=await Ee({...e,outputLanguage:n}),l=await _("prompt",s,t?.modeOverride);return R(r,t?.modeOverride,!1,"prompt",s,async()=>{if(typeof LanguageModel>"u")throw new Error("LanguageModel API not available in this browser.");d("prompt",r,t,{step:"on-device:init",source:"on-device",message:"Creating LanguageModel session"});let u=[];if(typeof e.messages!="string"){for(let f of e.messages)f.role==="system"&&f.content.trim()&&u.push(f.content.trim());a&&a.trim()&&u.push("SHARED CONTEXT: "+a.trim())}let c=u.length>0?u.join(`

`):void 0,m=c?[{role:"system",content:c}]:void 0,g=O(t);try{let f=await LanguageModel.create({...s,initialPrompts:m,monitor(b){b.addEventListener("downloadprogress",p=>{let h=p.loaded;d("prompt",r,t,{step:"on-device:download",source:"on-device",progress:h,loaded:h})})}});d("prompt",r,t,{step:"on-device:ready",source:"on-device"});try{d("prompt",r,t,{step:"on-device:run",source:"on-device",message:"Generating text"});let b=await f.prompt(Ot(e),{signal:g.signal,responseConstraint:e.responseConstraint});return o?{result:(await U({text:b,sourceLanguage:n,targetLanguage:i},{context:r,signal:g.signal})).result}:{result:b}}finally{try{f.destroy()}catch(b){console.error("Error destroying LanguageModel:",b)}}}finally{g.dispose()}},await ft({...e,sharedContext:a},r,l,t),t)},zt=async(e,t)=>{let r="frontend",a=e.sharedContext??D(),n="prompt",i=await E(),o={feature:n,mode:"backend-only",onDeviceAvailable:!1,backendAvailable:i.available,backendTransport:i.transport,backendApiName:i.apiName,backendBaseUrl:i.baseUrl,backendReason:i.reason},s=await bt({sessionId:e.sessionId,message:e.message,images:e.images,sharedContext:a},o,t);d(n,r,t,{step:"backend:request",source:"backend"});let l=await I(o,r,n,s,t);return d(n,r,t,{step:"done",source:"backend"}),l},Wt=async(e,t)=>{let r="frontend",a="prompt",n=await E(),i={feature:a,mode:"backend-only",onDeviceAvailable:!1,backendAvailable:n.available,backendTransport:n.transport,backendApiName:n.apiName,backendBaseUrl:n.baseUrl,backendReason:n.reason},o=await yt({sessionId:e.sessionId,feedbackMessageId:e.feedbackMessageId,feedbackType:e.feedbackType});d(a,r,t,{step:"backend:request",source:"backend"});let s=await I(i,r,a,o,t);return d(a,r,t,{step:"done",source:"backend"}),s}});var ur={};z(ur,{AiKitChatbotIcon:()=>Xe,AiKitFeatureIcon:()=>Ge,BackendError:()=>P,LANGUAGE_OPTIONS:()=>te,TEXT_DOMAIN:()=>y,checkOnDeviceAvailability:()=>qt,decideCapability:()=>_t,detectLanguage:()=>rr,dispatchBackend:()=>jt,getAiKitPlugin:()=>L,getMinChromeVersions:()=>Nt,getPromptOptions:()=>nr,getProofreadOptions:()=>Jt,getRewriteOptions:()=>Gt,getStore:()=>ae,getStoreDispatch:()=>ie,getStoreSelect:()=>K,getSummarizeOptions:()=>Zt,getTranslateOptions:()=>er,getWriteOptions:()=>Vt,initializeAiKit:()=>sr,observeStore:()=>ue,prompt:()=>ar,proofread:()=>Qt,rewrite:()=>Xt,sanitizeAiKitConfig:()=>G,sendChatMessage:()=>or,sendFeedbackMessage:()=>ir,summarize:()=>Yt,translate:()=>tr,waitForAiKitReady:()=>H,write:()=>$t});module.exports=_e(ur);var De,v,te,re,Nt,_t,qt,Ht,jt,w,Vt,$t,Gt,Xt,Jt,Qt,Zt,Yt,er,tr,rr,nr,ar,or,ir,sr,Me=k(()=>{De=require("@smart-cloud/wpsuite-core"),v=require("@wordpress/i18n");j();W();le();W();ce();X();te=[{label:(0,v.__)("Arabic",y),value:"ar"},{label:(0,v.__)("Chinese",y),value:"zh"},{label:(0,v.__)("Dutch",y),value:"nl"},{label:(0,v.__)("English",y),value:"en"},{label:(0,v.__)("French",y),value:"fr"},{label:(0,v.__)("German",y),value:"de"},{label:(0,v.__)("Hebrew",y),value:"he"},{label:(0,v.__)("Hindi",y),value:"hi"},{label:(0,v.__)("Hungarian",y),value:"hu"},{label:(0,v.__)("Indonesian",y),value:"id"},{label:(0,v.__)("Italian",y),value:"it"},{label:(0,v.__)("Japanese",y),value:"ja"},{label:(0,v.__)("Korean",y),value:"ko"},{label:(0,v.__)("Norwegian",y),value:"no"},{label:(0,v.__)("Polish",y),value:"pl"},{label:(0,v.__)("Portuguese",y),value:"pt"},{label:(0,v.__)("Russian",y),value:"ru"},{label:(0,v.__)("Spanish",y),value:"es"},{label:(0,v.__)("Swedish",y),value:"sv"},{label:(0,v.__)("Thai",y),value:"th"},{label:(0,v.__)("Turkish",y),value:"tr"},{label:(0,v.__)("Ukrainian",y),value:"uk"}],re=Promise.resolve().then(()=>(J(),ye)),Nt=async()=>(await re).MIN_CHROME_VERSION,_t=async(...e)=>(await re).decideCapability(...e),qt=async(...e)=>(await re).checkOnDeviceAvailability(...e),Ht=Promise.resolve().then(()=>(Z(),ke)),jt=async(...e)=>(await Ht).dispatchBackend(...e),w=Promise.resolve().then(()=>(Ie(),Fe)),Vt=async(...e)=>(await w).getWriteOptions(...e),$t=async(...e)=>(await w).write(...e),Gt=async(...e)=>(await w).getRewriteOptions(...e),Xt=async(...e)=>(await w).rewrite(...e),Jt=async(...e)=>(await w).getProofreadOptions(...e),Qt=async(...e)=>(await w).proofread(...e),Zt=async(...e)=>(await w).getSummarizeOptions(...e),Yt=async(...e)=>(await w).summarize(...e),er=async(...e)=>(await w).getTranslateOptions(...e),tr=async(...e)=>(await w).translate(...e),rr=async(...e)=>(await w).detectLanguage(...e),nr=async(...e)=>(await w).getPromptOptions(...e),ar=async(...e)=>(await w).prompt(...e),or=async(...e)=>(await w).sendChatMessage(...e),ir=async(...e)=>(await w).sendFeedbackMessage(...e),sr=e=>{let t=globalThis.WpSuite,r=L();if(!r)throw console.error("AiKit plugin is not available"),new Error("AiKit plugin is not available");(0,De.attachDefaultPluginRuntime)(r),r.status=r.status??"initializing";let a=se();return r.features={store:a,renderFeature:async n=>await e({...n,store:await a}),write:async(...n)=>{let i=await w,o=n[1]||{};return n[1]={context:"frontend",...o},i.write(...n)},rewrite:async(...n)=>{let i=await w,o=n[1]||{};return n[1]={context:"frontend",...o},i.rewrite(...n)},proofread:async(...n)=>{let i=await w,o=n[1]||{};return n[1]={context:"frontend",...o},i.proofread(...n)},summarize:async(...n)=>{let i=await w,o=n[1]||{};return n[1]={context:"frontend",...o},i.summarize(...n)},translate:async(...n)=>{let i=await w,o=n[1]||{};return n[1]={context:"frontend",...o},i.translate(...n)},detectLanguage:async(...n)=>{let i=await w,o=n[1]||{};return n[1]={context:"frontend",...o},i.detectLanguage(...n)},prompt:async(...n)=>{let i=await w,o=n[1]||{};return n[1]={context:"frontend",...o},i.prompt(...n)},sendChatMessage:async(...n)=>(await w).sendChatMessage(...n),sendFeedbackMessage:async(...n)=>(await w).sendFeedbackMessage(...n)},a.then(()=>{r.status="available",t?.events?.emit("wpsuite:ai-kit:ready",{key:r.key,version:r.version})}).catch(n=>{r.status="error",console.error("AiKit plugin failed to initialize:",n),t?.events?.emit("wpsuite:ai-kit:error",{key:r.key,error:String(n)})}),r}});Me();0&&(module.exports={AiKitChatbotIcon,AiKitFeatureIcon,BackendError,LANGUAGE_OPTIONS,TEXT_DOMAIN,checkOnDeviceAvailability,decideCapability,detectLanguage,dispatchBackend,getAiKitPlugin,getMinChromeVersions,getPromptOptions,getProofreadOptions,getRewriteOptions,getStore,getStoreDispatch,getStoreSelect,getSummarizeOptions,getTranslateOptions,getWriteOptions,initializeAiKit,observeStore,prompt,proofread,rewrite,sanitizeAiKitConfig,sendChatMessage,sendFeedbackMessage,summarize,translate,waitForAiKitReady,write});
